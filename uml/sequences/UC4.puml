@startuml
title UC4 - Enregistrer un objet trouvé et notifier les victimes (Observer)

actor "Agent de police" as A
boundary "Interface Web" as UI
control "ControleurObjetsTrouves" as CtrlOT
control "DeclarationService" as DeclService
entity "ObjetTrouveService\n<<Subject>>" as OTService
database "DepotObjetsTrouves" as RepoOT
database "DepotDeclarations" as RepoDecl
entity "Victime\n<<Observer>>" as Victime

' 1. Accès au cas d'utilisation
A -> UI : enregistrerObjetTrouve()
UI -> CtrlOT : initierEnregistrement()

CtrlOT -> UI : afficherFormulaire()

' 2. Saisie de l'objet trouvé
A -> UI : saisirCaracteristiquesObjet()
UI -> CtrlOT : soumettreObjet(donneesObjet)

' 3. Validation + enregistrement
CtrlOT -> OTService : creerObjetTrouve(donneesObjet)
OTService -> OTService : valider()

alt données invalides
    OTService --> CtrlOT : erreurValidation()
    CtrlOT -> UI : presenterErreurs()
    UI --> A : afficherErreurs()
else données valides
    OTService -> RepoOT : sauvegarder(objetTrouve)
    RepoOT --> OTService : confirmation

    ' 4. Recherche des correspondances
    OTService -> DeclService : rechercherCorrespondances(objetTrouve)
    DeclService -> RepoDecl : extraireDeclarationsSimilaires(objetTrouve)
    RepoDecl --> DeclService : declarationsCorrespondantes
    DeclService --> OTService : victimesObservatrices

    alt aucune correspondance
        OTService --> CtrlOT : objetEnregistreSansCorrespondance()
        CtrlOT -> UI : presenterConfirmation("Aucune correspondance")
        UI --> A : afficherConfirmation()
    else correspondances trouvees
        ' 5. Notification via Observer
        OTService -> OTService : notifyObservers()

        loop pour chaque victime
            OTService -> Victime : update(objetTrouve)
        end

        OTService --> CtrlOT : objetEnregistreEtNotificationsEnvoyees()
        CtrlOT -> UI : presenterConfirmation("Victimes notifiées")
        UI --> A : afficherConfirmation()
    end
end

@enduml
